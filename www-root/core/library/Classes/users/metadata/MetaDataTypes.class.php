<?php
/**
 * Entrada [ http://www.entrada-project.org ]
 * 
 *
 * 
 * @author Organisation: Queen's University
 * @author Unit: School of Medicine
 * @author Developer: Jonathan Fingland <jonathan.fingland@queensu.ca>
 * @copyright Copyright 2011 Queen's University. All Rights Reserved.
*/

/**
 * Provides a collection wrapper for MetaDataType objects and methods for retrieving them
 * 
 * @author Jonathan Fingland
 *
 */
class MetaDataTypes extends Collection {

	//we want to only load these types once.
	private static $has_init = false;
	
	/**
	 * caching location for all types
	 * @var MetaDataTypes
	 */
	private static $types; 
	
	/**
	 * Returns all MetaDataTypes irrespective of permissions
	 * <code>
	 * $types = MetaDataTypes::getAll();
	 * foreach ($types as $type) { ... } 
	 * @return MetaDataTypes
	 */
	public static function getAll() {
		if (self::$has_init) {
			return self::$types;
		}
		global $db;
		
		$query = "SELECT * from `meta_types`";
		
		$results = $db->getAll($query);
		$types = array();
		if ($results) {
			foreach ($results as $result) {
				$type =  MetaDataType::fromArray($result);
				$types[] = $type;
			}
		}
		self::$types = new self($types);
		self::$has_init = true;
	}
	
	/**
	 * Returns all types matching the mask generated by the four parameters
	 * 
	 * <code>
	 * $types = MetaDataTypes::get(1);
	 * //returns all types applicable to organisation id 1
	 * 
	 * $types = MetaDataTypes::get(1, "student");
	 * //returns all types applicable to members of the "student" group in organisation id 1
	 * </code>
	 * 
	 * @param $organisation
	 * @param $group
	 * @param $role
	 * @param $user
	 * @return MetaDataTypes
	 */
	public static function get($organisation=null, $group=null, $role=null, $user=null) {
		if (!self::$has_init) {
			self::getAll();
		}
		$relations = MetaDataRelations::getRelations($organisation, $group, $role, $user);
		$applicable_types = array();
		foreach ($relations as $relation) {
			$applicable_types[] = $relation->getMetaDataType(); 
		}
		return new self($applicable_types);
	}

	/**
	 * Returns all other types matching this $id in this organisation
	 * @param $id
	 * @return array
	 */
	public function getSelectionOption($id = 0) {
		global $db, $ORGANISATION_ID;
		$query = "	SELECT DISTINCT a.`meta_type_id`, a.`label`
					FROM `meta_types` AS a
	  				JOIN `meta_type_relations` AS b
					ON a.`meta_type_id` = b.`meta_type_id`
	  				AND b.`entity_value` LIKE ".$db->qstr($ORGANISATION_ID.":%")."
					WHERE a.`parent_type_id` IS NULL
	  				AND a.`meta_type_id` <> ".$db->qstr($id);
		return $db->GetAll($query);
	}

	/**
	 * Returns all types matching this parent $id in this organisation
	 * @param $id
	 * @return array
	 */
	public function getSelectionByParent($id = 0) {
		global $db;
		$query = "	SELECT `meta_type_id`, `label`
					FROM `meta_types`
					WHERE `parent_type_id` = ".$db->qstr($id);
		return $db->GetAll($query);
	}
}