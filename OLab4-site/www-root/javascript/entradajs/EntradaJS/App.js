'use strict';var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if('value'in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError('Cannot call a class as a function')}}var EntryPoint=use('./View/EntryPoint');var Kernel=use('./Kernel/Kernel');var ModuleManager=use('./Module/Manager');var Router=use('./Routing/Router');var State=use('./State/State');var Translator=use('./Localization/Translator');module.exports=function(){function App(selector,config,loader){var _this=this;_classCallCheck(this,App);this.vm=null;this.loader=loader;this.entryPoint=EntryPoint.createFromElement(selector);this.config=config;this.state=new State;this.translator=new Translator;this.router=new Router;this.moduleManager=new ModuleManager(this.config.moduleNamespace(),this.loader);this.kernel=new Kernel(this.moduleManager,this.loader);this.translator.enableMissingTranslationWarnings();this.initializeState();this.installVuePlugins();var modulesToLoad=new Set;var _iteratorNormalCompletion=true;var _didIteratorError=false;var _iteratorError=undefined;try{for(var _iterator=this.config.registeredModules()[Symbol.iterator](),_step;!(_iteratorNormalCompletion=(_step=_iterator.next()).done);_iteratorNormalCompletion=true){var moduleDefinition=_step.value;modulesToLoad.add(moduleDefinition.name)}}catch(err){_didIteratorError=true;_iteratorError=err}finally{try{if(!_iteratorNormalCompletion&&_iterator.return){_iterator.return()}}finally{if(_didIteratorError){throw _iteratorError}}}this.moduleManager.loadModules(modulesToLoad).then(function(modules){_this.router.addRouteCollections(_this.moduleManager.getRouteCollections());_this.start()})}_createClass(App,[{key:'initializeState',value:function initializeState(){this.state.language='en-US';this.state.views={current:null};new Vue({data:{state:this.state}})}},{key:'installVuePlugins',value:function installVuePlugins(){var _this2=this;Vue.prototype.$state=this.state;Vue.prototype.$translate=function(string){return _this2.translator.translate(_this2.state.language,string)};Vue.prototype.$setLanguage=function(code){return _this2.state.language=code};Vue.prototype.$getRoute=function(){return _this2.router.getMatchedRoute()};Vue.prototype.$generatePath=function(name){var args=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};return _this2.router.generate(name,args)};Vue.prototype.$findRouteByName=function(name){return _this2.router.findRouteByName(name)};Vue.directive('i18n',{bind:function bind(el,binding,vnode){if(vnode.children){var nodeText=vnode.children[0].text;el.innerHTML=_this2.translator.translate(_this2.state.language,nodeText)}},update:function update(el,binding,vnode){if(vnode.children){var nodeText=vnode.children[0].text;el.innerHTML=_this2.translator.translate(_this2.state.language,nodeText)}}})}},{key:'applyLayout',value:function applyLayout(){var _this3=this;var layout_name=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var path=void 0;if(layout_name){path=this.config.layoutNamespace()+'/'+layout_name+'.vue'}else{path='EntradaJS/View/Component/NoLayout.vue'}this.loader.load(path).then(function(layoutClass){_this3.vm=new Vue(layoutClass).$mount(_this3.entryPoint.getSelector());_this3.vm.$watch(function(){return _this3.state.views.current},function(newVal){var viewPane=jQuery(_this3.vm.$el).find('.view-pane')[0].__vue__;viewPane.setView(newVal)})})}},{key:'start',value:function start(){var _this4=this;jQuery(window).on('hashchange',function(e){if(window.location.hash.startsWith('#/')){var route=_this4.router.match(window.location.hash);if(route){_this4.kernel.exec(route.getDefaults()['_controller']).then(function(component){_this4.state.views.current=component})}else{throw new Error('A route could not be found for this path: '+window.location.hash)}}});this.applyLayout(this.entryPoint.getLayoutName());if(!window.location.hash){window.history.replaceState({},'','#'+this.router.generate(this.entryPoint.getRouteName(),this.entryPoint.getRouteParameters()))}setTimeout(function(){jQuery(window).trigger('hashchange')},1)}}]);return App}();